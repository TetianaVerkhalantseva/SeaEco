@page "/editUser/{userId:guid}"
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@attribute [Authorize(Roles = "admin")]
@using SeaEco.Abstractions.Models.User
@using SeaEco.Client.Resources
@inject NavigationManager Navigation

<EditForm Model="userEdit" OnValidSubmit="HandleValidSubmit" >
    <DataAnnotationsValidator />
    <div class="d-flex flex-column align-items-center">

        @if (isLoading)
        {
        }
        else if (user == null)
        {
            <div class="mb-3">
                <h3>Rediger brukeren @($"{userEdit.FirstName}") @($"{userEdit.LastName}") </h3>
            </div>
            <p>Fant ikke bruker.</p>
        }
        else
        {
            <div class="mb-3">
                <h3>Rediger brukeren @($"{userEdit.FirstName}") @($"{userEdit.LastName}") </h3>
            </div>
            <div class="d-flex flex-column ">
                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-center gap-2">
                        <InputText id="firstName" class="form-control" @bind-Value="userEdit.FirstName" placeholder="Fornavn" />
                        <InputText id="lastName" class="form-control" @bind-Value="userEdit.LastName" placeholder="Etternavn" />
                    </div>
                    <InputText id="email" class="form-control" @bind-Value="userEdit.Email" placeholder="Epost-adresse" />
                    </div>

                <div class="mt-2">
                    <input type="checkbox" id="admin" @bind="userEdit.IsAdmin" />
                    <span title="@TextResources.AdminTooltip">
                        <label class="ms-1" for="admin">Admin</label>
                    </span>
                </div>
                <div class="mt-1">
                    <input type="checkbox" id="activ" @bind="userEdit.IsActive"  />
                    <label class="ms-1" for="activ">Aktiv bruker</label>
                </div>

                <div class="d-flex justify-content-center">
                    <NavLink class="btn btn-secondary me-2" href="/user">Avbryt</NavLink>
                    <button typee = submit class="btn btn-secondary me-2"> Lagre</button>
                </div>

                <div class="mt-3 text-center" style="height: 30px">
                    <div class="custom-validation-summary">
                        <ValidationSummary/>
                    </div>

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <p class="text-danger">@_errorMessage</p>
                    }
                </div>
            </div>
        }
    </div>
</EditForm>

@code {
    [Parameter]
    public Guid userId { get; set; }
    private UserDto user;
    private EditUserDto userEdit = new EditUserDto();
    private bool isLoading = true;
    private string?  _errorMessage;


    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            user = await Http.GetFromJsonAsync<UserDto>($"api/users/{userId}");
            if (user != null)
            {
                userEdit = new EditUserDto
                {
                    FirstName = user.FirstName,
                    LastName = user.LastName,
                    Email = user.Email,
                    IsAdmin = user.IsAdmin,
                    IsActive = user.IsActive
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Feil ved lasting av bruker: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task HandleValidSubmit()
    {
        var response = await Http.PutAsJsonAsync($"api/users/{user.Id:D}/update", userEdit);
        if (response.IsSuccessStatusCode)
        {    
            Navigation.NavigateTo("/user", forceLoad: true);
        }
        else
        {
            _errorMessage = @TextResources.UnexpectedErrorMessage;
        }
    }
    

}
