@page "/newProject/{CustomerId:guid}"
@using System.Net
@using Microsoft.AspNetCore.Authorization
@using SeaEco.Abstractions.Enums
@using SeaEco.Abstractions.Extensions
@using SeaEco.Abstractions.Models.Project
@attribute [Authorize(Roles = "admin")]
@using SeaEco.Client.Resources
@using SeaEco.Abstractions.Models.User
@inject HttpClient Http
@using SeaEco.EntityFramework.Entities
@inject NavigationManager Navigation


@if (_isLoading)
{
}
else
{
    <EditForm Model="_newProject" OnValidSubmit="AddNewProject">
    <DataAnnotationsValidator />

    <div class="d-flex flex-column align-items-center gap-3 mb-3">
        <div class="mb-3">
            <h2>Nytt prosjekt</h2>
            <h6 class="text-secondary">- @_customer.Oppdragsgiver</h6>
        </div>
        <div class="d-flex justify-content-lg-start flex-column gap-3">
            <div class="d-flex gap-3">
                <div class="form-floating flex-fill">
                    <InputText class="form-control" id="poId" @bind-Value="_newProject.PoId" @oninput="() => _errorMessage = null"/>
                    <label for="poId">PO-ID</label>
                </div>
            </div>
            <div class="d-flex flex-column mt-4 mb-4 gap-3">
                <div class="d-flex gap-3">
                    <div class="form-floating flex-fill" style="min-width:600px;">
                        <InputText class="form-control" id="contactCustomer" @bind-Value="_newProject.Kundekontaktperson" @oninput="() => _errorMessage = null"/>
                        <label for="contactCustomer">Kontaktperson</label>
                    </div>
                </div>
                <div class="d-flex gap-3">
                    <div class="form-floating">
                        <InputText class="form-control" id="tlfCustomer" @bind-Value="_newProject.Kundetlf" @oninput="() => _errorMessage = null"/>
                        <label for="tlfCustomer">Telefonnummer</label>
                    </div>
                    <div class="form-floating flex-fill">
                        <InputText class="form-control" id="emailCustomer" @bind-Value="_newProject.Kundeepost" @oninput="() => _errorMessage = null"/>
                        <label for="emailCustomer">epost</label>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-3">
                <div class="form-floating flex-fill">
                    <InputSelect @bind-Value="_newProject.Produksjonsstatus" id="productionStatus" class="form-select" @oninput="() => _errorMessage = null">
                        <option value=""></option>
                        @foreach (var status in Enum.GetValues<Produksjonsstatus>())
                        {
                            <option value="@status">@status.GetDescription()</option>
                        }
                    </InputSelect>
                    <label for="productionStatus">Produksjonsstatus</label>
                </div>
                <div class="form-floating">
                    <InputNumber class="form-control" id="mtb" @bind-Value="_newProject.Mtbtillatelse" @oninput="() => _errorMessage = null"/>
                    <label for="mtb">MTB-tilatelse (tonn)</label>
                </div>
            </div>

            <div class="d-flex gap-3 align-items-end">
                @if (!_isNewLocality)
                {
                    <div class="form-floating flex-fill">
                        <InputSelect @bind-Value="_newProject.Lokalitetsnavn" id="locality" class="form-select" @oninput="() => _errorMessage = null">
                            <option value=""></option>
                            @foreach (var loc in _lokalities)
                            {
                                <option value="@loc.Id">@loc.Lokalitetsnavn (@loc.LokalitetsId)</option>
                            }
                        </InputSelect>
                        <label for="locality">Lokalitet</label>
                    </div>
                }
                else
                {
                    <div class="form-floating flex-fill">
                        <InputText class="form-control" id="newLocalityName" @bind-Value="_newProject.Lokalitetsnavn" @oninput="() => _errorMessage = null"/>
                        <label for="newLocalityName">Lokalitetsnavn</label>
                    </div>
                    <div class="form-floating">
                        <InputText class="form-control" id="newLocalityId" @bind-Value="_newProject.LokalitetsId" @oninput="() => _errorMessage = null"/>
                        <label for="newLocalityId">Lokalitets-Id</label>
                    </div>
                }
            </div>

            <button type="button"
                    class="btn custom-btn align-self-end" style="min-width: 155px"
                    @onclick="ToggleLocalityButton">
                @(_isNewLocality ? "Eksisterende" : "Ny lokalitet")
            </button>
            
            
            <div class="d-flex gap-3 mt-4">
                <div class="d-flex form-floating flex-fill">
                    <InputSelect @bind-Value="_newProject.ProsjektansvarligId" id="user" class="form-select" @oninput="() => _errorMessage = null">
                        <option value=""></option>
                        @foreach (var user in _users)
                        {
                            <option value="@user.Id">@user.FullName</option>
                        }
                    </InputSelect>
                    <label for="user">Ansvarlig ansatt</label>
                </div>
            </div>
            <div class="d-flex w-100 mt-4 mb-4">
                <div class="form-floating w-100">
                    <InputTextArea class="form-control" style="height: 150px;" id="comment" @bind-Value="_newProject.Merknad" @oninput="() => _errorMessage = null"/>
                    <label for="comment">Merknad</label>
                </div>
            </div>
        </div>
        <div class="d-flex gap-3">
            <NavLink class="btn custom-outline-secondary-btn align-self-start" type="button" href=@($"/CustomerInfo/{CustomerId}")>@Resources.ButtonCancel</NavLink>
            <button type=submit class="btn custom-btn align-self-end">
                @Resources.ButtonSave
            </button>
        </div>
    </div>
        <div class=" text-center">
            <div class="custom-validation-summary">
                <ValidationSummary/>
            </div>
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <p class="text-danger">@_errorMessage</p>
            }
        </div>
    </EditForm>
}

@code {
    private NewProjectDto _newProject = new();
    private List<LocalityDto> _lokalities = [new()];
    private List<UserDto> _users = [new()];
    private Kunde? _customer = new();
    private bool _isLoading = true;
    [Parameter] public Guid CustomerId { get; set; }
    private string? _errorMessage;
    private bool _isNewLocality;
    

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _customer = await Http.GetFromJsonAsync<Kunde>($"api/Customer/{CustomerId}");
            if (_customer != null)
            {
                _newProject = new NewProjectDto
                {
                    Kundekontaktperson = _customer.Kontaktperson,
                    Kundetlf = _customer.Telefon,
                    ProsjektansvarligId = null
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Feil ved lasting av kunde: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }

        var usersList = await Http.GetFromJsonAsync<List<UserDto>>("api/users");
        _users = usersList?.OrderBy(user => user.FullName).ToList();

        _lokalities =
        [
            ..new List<LocalityDto>
            {
                new LocalityDto
                {
                    Id = Guid.Parse("22222222-2222-2222-2222-222222222222"),
                    Lokalitetsnavn = "Bergen Brygge", 
                    LokalitetsId = "12345"
                        
                }
            }
        ];
        //_lokalities = await Http.GetFromJsonAsync<Lokalitet>($"api/Project/Lokalitet");
    }

    private async Task AddNewProject()
    {
        
        var response = await Http.PostAsJsonAsync("/api/Project", _newProject);
        
        if (response.StatusCode == HttpStatusCode.Conflict)
        {
            _errorMessage = await response.Content.ReadAsStringAsync();
        }
        else if (response.IsSuccessStatusCode)
        {
            var created = await response.Content
                .ReadFromJsonAsync<CreateProjectResponse>();

            if (created is not null)
            {
                Navigation.NavigateTo($"project/{created.Id:D}", forceLoad: true);
            }
            else
            {
                _errorMessage = Resources.ErrorMessageUnexpected;
            }
        }
        else
        {
            _errorMessage = Resources.ErrorMessageUnexpected;
        }
    }
    
    
    private void ToggleLocalityButton()
    {
        _isNewLocality = !_isNewLocality;
        
        if (_isNewLocality)
        {
            _newProject.LokalitetsId = null!;
            _newProject.Lokalitetsnavn = null!;
        }
        else
        {
            _newProject.Lokalitetsnavn = null!;
            _newProject.LokalitetsId   = null!;
        }
    }
    
    public class CreateProjectResponse
    {
        public Guid Id { get; init; }
    }
}
