@page "/resetPassword"
@using SeaEco.Abstractions.Models.Authentication
@using SeaEco.Client.Resources
@inject NavigationManager Navigation
@inject HttpClient Http


<EditForm Model="_password" OnValidSubmit="ToMainPage" >
    <DataAnnotationsValidator />
<div class="d-flex flex-column align-items-center ">
    <div class="mb-3">
        <h3>Forny passord</h3>
        <p>Skriv inn ditt nye passord</p>
    </div>

    <div class="d-flex flex-column gap-4">
        <div class="d-flex flex-column gap-2">
            @if (_password != null)
            {
                <InputText type="password" id="password" class="form-control" @bind-Value="_password.Password" placeholder="@Resources.InputTextPassword" @oninput="() => _errorMessage = null"/>
                <InputText type="password" id="confirmPassword" class="form-control" @bind-Value="_password.ConfirmPassword" placeholder="@Resources.InputTextRepPassword" @oninput="() => _errorMessage = null"/>
            }
        </div>
        
        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-secondary">Lagre</button>
        </div>
        

        <div class=" text-center">
                <div class="custom-validation-summary">
                    <ValidationSummary/>
                </div>   
            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <p class="text-danger">@_errorMessage</p>
            }
        </div>
    </div>
</div>
</EditForm>

@code {
    private readonly ResetPasswordConfirmDto? _password = new();
    private string? _errorMessage;


    private async Task ToMainPage()
    {
        _errorMessage = string.Empty;
        
        var response = await Http.PostAsJsonAsync("api/authentication/reset-password",_password);
        
        if (response.IsSuccessStatusCode)
        {    
            Navigation.NavigateTo("/projectsOverview", forceLoad: true);
        }
        else
        {
            _errorMessage = response.StatusCode == System.Net.HttpStatusCode.BadRequest ? Resources.ErrorMessageWrongMailOrPassword : Resources.ErrorMessageUnexpected;
        }
    }
}